<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الفواتير | Sawa POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(to bottom right, #7C3AED, #4F46E5);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body class="text-white p-6">
    <!-- شريط التنقل -->
    <nav class="bg-white/10 backdrop-blur-md p-4 rounded-xl mb-6 flex justify-between items-center">
        <div class="flex items-center space-x-4 space-x-reverse">
            <a href="dashboard.html" class="bg-white/20 px-4 py-2 rounded-lg hover:bg-white/30 transition">
                <i class="fa-solid fa-arrow-right ml-2"></i> العودة
            </a>
            <h1 class="text-xl font-bold flex items-center">
                <i class="fa-solid fa-file-invoice ml-2"></i> إدارة الفواتير
            </h1>
        </div>
        
        <div class="flex items-center space-x-2 space-x-reverse">
            <div id="clock" class="bg-white/10 px-3 py-1 rounded-lg"></div>
        </div>
    </nav>

    <div class="bg-white/20 backdrop-blur-md rounded-xl p-5">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h2 class="text-2xl font-bold">سجل الفواتير</h2>
                <p class="text-white/70">إجمالي الفواتير: <span id="invoicesCount">0</span></p>
            </div>
            
            <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                <input id="invoiceSearch" type="text" placeholder="ابحث برقم الفاتورة أو العميل..." 
                    class="px-4 py-2 rounded-lg bg-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50">
                <select id="dateFilter" class="px-4 py-2 rounded-lg bg-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
                    <option value="all">جميع الفواتير</option>
                    <option value="today">فواتير اليوم</option>
                    <option value="week">هذا الأسبوع</option>
                    <option value="month">هذا الشهر</option>
                </select>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-center">
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="pb-3">رقم الفاتورة</th>
                        <th class="pb-3">التاريخ</th>
                        <th class="pb-3">العميل</th>
                        <th class="pb-3">طريقة الدفع</th>
                        <th class="pb-3">عدد المنتجات</th>
                        <th class="pb-3">المبلغ الإجمالي</th>
                        <th class="pb-3">المستخدم</th>
                        <th class="pb-3">الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="invoicesTable">
                    <!-- سيتم ملؤها بالفواتير -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- نافذة تفاصيل الفاتورة -->
    <div id="invoiceModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden overflow-y-auto">
        <div class="bg-white text-gray-800 rounded-xl w-full max-w-2xl mx-4 p-6 my-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">تفاصيل الفاتورة</h3>
                <button onclick="closeInvoiceModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="invoiceDetails">
                <!-- سيتم ملؤها بتفاصيل الفاتورة -->
            </div>
            
            <div class="flex justify-end space-x-2 space-x-reverse mt-6">
                <button onclick="printInvoice()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <i class="fa-solid fa-print ml-2"></i> طباعة
                </button>
                <button onclick="closeInvoiceModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        let currentInvoice = null;
        
        // تهيئة التطبيق
        SAWA_POS.init();
        renderInvoicesTable();

        // عرض جدول الفواتير
        function renderInvoicesTable(searchTerm = '', dateFilter = 'all') {
            let filteredInvoices = [...window.appData.invoices].reverse(); // عرض أحدث الفواتير أولاً
            
            if (searchTerm) {
                filteredInvoices = filteredInvoices.filter(invoice => 
                    invoice.id.toString().includes(searchTerm) || 
                    invoice.customer.includes(searchTerm)
                );
            }
            
            if (dateFilter !== 'all') {
                const today = new Date();
                filteredInvoices = filteredInvoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.date);
                    
                    switch(dateFilter) {
                        case 'today':
                            return invoiceDate.toDateString() === today.toDateString();
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(today.getDate() - 7);
                            return invoiceDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(today.getMonth() - 1);
                            return invoiceDate >= monthAgo;
                        default:
                            return true;
                    }
                });
            }
            
            const invoicesHtml = filteredInvoices.map(invoice => `
                <tr class="border-b border-white/10 hover:bg-white/10">
                    <td class="py-3 font-mono">${invoice.id}</td>
                    <td class="py-3">${invoice.date}<br><span class="text-xs text-white/70">${invoice.time}</span></td>
                    <td class="py-3">${invoice.customer}</td>
                    <td class="py-3">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            invoice.paymentMethod === 'نقدي' ? 'bg-green-500/20 text-green-300' :
                            invoice.paymentMethod === 'بطاقة' ? 'bg-blue-500/20 text-blue-300' :
                            'bg-purple-500/20 text-purple-300'
                        }">
                            ${invoice.paymentMethod}
                        </span>
                    </td>
                    <td class="py-3">${invoice.items.length}</td>
                    <td class="py-3 font-semibold">${SAWA_POS.formatCurrency(invoice.total)}</td>
                    <td class="py-3 text-sm">${invoice.user || 'النظام'}</td>
                    <td class="py-3">
                        <button onclick="viewInvoiceDetails(${invoice.id})" 
                            class="text-blue-400 hover:text-blue-600 mx-1" title="عرض التفاصيل">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <button onclick="printSingleInvoice(${invoice.id})" 
                            class="text-green-400 hover:text-green-600 mx-1" title="طباعة">
                            <i class="fa-solid fa-print"></i>
                        </button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="8" class="py-4 text-white/50">لا توجد فواتير</td></tr>';
            
            document.getElementById('invoicesTable').innerHTML = invoicesHtml;
            document.getElementById('invoicesCount').textContent = filteredInvoices.length;
            
            // البحث في الفواتير
            document.getElementById('invoiceSearch').addEventListener('input', function() {
                renderInvoicesTable(this.value, document.getElementById('dateFilter').value);
            });
            
            // تصفية حسب التاريخ
            document.getElementById('dateFilter').addEventListener('change', function() {
                renderInvoicesTable(document.getElementById('invoiceSearch').value, this.value);
            });
        }

        // عرض تفاصيل الفاتورة
        function viewInvoiceDetails(invoiceId) {
            currentInvoice = window.appData.invoices.find(inv => inv.id === invoiceId);
            
            if (!currentInvoice) return;
            
            const itemsHtml = currentInvoice.items.map(item => `
                <tr class="border-b border-gray-200">
                    <td class="py-2">${item.name}</td>
                    <td class="py-2">${item.quantity}</td>
                    <td class="py-2">${SAWA_POS.formatCurrency(item.price)}</td>
                    <td class="py-2">${SAWA_POS.formatCurrency(item.price * item.quantity)}</td>
                </tr>
            `).join('');
            
            document.getElementById('invoiceDetails').innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <strong>رقم الفاتورة:</strong> ${currentInvoice.id}
                    </div>
                    <div>
                        <strong>التاريخ والوقت:</strong> ${currentInvoice.date} ${currentInvoice.time}
                    </div>
                    <div>
                        <strong>العميل:</strong> ${currentInvoice.customer}
                    </div>
                    <div>
                        <strong>طريقة الدفع:</strong> ${currentInvoice.paymentMethod}
                    </div>
                    <div>
                        <strong>المستخدم:</strong> ${currentInvoice.user || 'النظام'}
                    </div>
                </div>
                
                <h4 class="font-bold mb-3">المنتجات:</h4>
                <table class="w-full text-center mb-4">
                    <thead>
                        <tr class="border-b border-gray-300">
                            <th class="pb-2">المنتج</th>
                            <th class="pb-2">الكمية</th>
                            <th class="pb-2">سعر الوحدة</th>
                            <th class="pb-2">المجموع</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
                
                <div class="border-t border-gray-300 pt-3 space-y-2">
                    <div class="flex justify-between">
                        <span>المجموع:</span>
                        <span>${SAWA_POS.formatCurrency(currentInvoice.subtotal)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>الضريبة (10%):</span>
                        <span>${SAWA_POS.formatCurrency(currentInvoice.tax)}</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg">
                        <span>الإجمالي:</span>
                        <span>${SAWA_POS.formatCurrency(currentInvoice.total)}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('invoiceModal').classList.remove('hidden');
        }

        // إغلاق نافذة الفاتورة
        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.add('hidden');
            currentInvoice = null;
        }

        // طباعة الفاتورة
        function printInvoice() {
            if (!currentInvoice) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <title>فاتورة ${currentInvoice.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .details { margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        .total { border-top: 2px solid #333; padding-top: 10px; margin-top: 20px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>${window.appData.settings.companyName}</h2>
                        <h3>فاتورة مبيعات</h3>
                    </div>
                    
                    <div class="details">
                        <p><strong>رقم الفاتورة:</strong> ${currentInvoice.id}</p>
                        <p><strong>التاريخ:</strong> ${currentInvoice.date} ${currentInvoice.time}</p>
                        <p><strong>العميل:</strong> ${currentInvoice.customer}</p>
                        <p><strong>طريقة الدفع:</strong> ${currentInvoice.paymentMethod}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>سعر الوحدة</th>
                                <th>المجموع</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentInvoice.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${SAWA_POS.formatCurrency(item.price)}</td>
                                    <td>${SAWA_POS.formatCurrency(item.price * item.quantity)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="total">
                        <p><strong>المجموع:</strong> ${SAWA_POS.formatCurrency(currentInvoice.subtotal)}</p>
                        <p><strong>الضريبة:</strong> ${SAWA_POS.formatCurrency(currentInvoice.tax)}</p>
                        <p><strong>الإجمالي:</strong> ${SAWA_POS.formatCurrency(currentInvoice.total)}</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <p>شكراً لتعاملكم معنا</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // طباعة فاتورة محددة
        function printSingleInvoice(invoiceId) {
            currentInvoice = window.appData.invoices.find(inv => inv.id === invoiceId);
            if (currentInvoice) {
                printInvoice();
            }
        }
    </script>
</body>
</html>
