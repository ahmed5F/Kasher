<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقارير | Sawa POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.15);
        }
    </style>
</head>
<body class="text-white p-4">
    <!-- الشريط العلوي -->
    <nav class="card rounded-xl p-4 mb-6 flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <a href="dashboard.html" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-all">
                <i class="fa-solid fa-arrow-right ml-2"></i> العودة
            </a>
            <h1 class="text-xl font-bold flex items-center">
                <i class="fa-solid fa-chart-bar ml-2"></i> التقارير والإحصائيات
            </h1>
        </div>
        <div class="flex items-center space-x-4">
            <a href="index.html" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-all">
                <i class="fa-solid fa-home ml-2"></i> الرئيسية
            </a>
        </div>
    </nav>

    <div class="container mx-auto">
        <!-- الإحصائيات السريعة -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card card rounded-xl p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-white/70 mb-2">إجمالي المبيعات</p>
                        <h3 class="text-2xl font-bold" id="totalSales">0 د.ع</h3>
                    </div>
                    <div class="bg-green-500/20 p-3 rounded-full">
                        <i class="fa-solid fa-money-bill-wave text-green-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card card rounded-xl p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-white/70 mb-2">عدد الفواتير</p>
                        <h3 class="text-2xl font-bold" id="totalInvoices">0</h3>
                    </div>
                    <div class="bg-blue-500/20 p-3 rounded-full">
                        <i class="fa-solid fa-receipt text-blue-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card card rounded-xl p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-white/70 mb-2">متوسط الفاتورة</p>
                        <h3 class="text-2xl font-bold" id="avgInvoice">0 د.ع</h3>
                    </div>
                    <div class="bg-purple-500/20 p-3 rounded-full">
                        <i class="fa-solid fa-chart-line text-purple-400 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card card rounded-xl p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-white/70 mb-2">أفضل عميل</p>
                        <h3 class="text-xl font-bold" id="topCustomer">-</h3>
                    </div>
                    <div class="bg-yellow-500/20 p-3 rounded-full">
                        <i class="fa-solid fa-crown text-yellow-400 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- أدوات التقرير -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- فلترة -->
            <div class="card rounded-xl p-6 lg:col-span-1">
                <h3 class="text-xl font-bold mb-4">إعدادات التقرير</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block mb-2">نوع التقرير</label>
                        <select id="reportType" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
                            <option value="sales">تقرير المبيعات</option>
                            <option value="products">تقرير المنتجات</option>
                            <option value="customers">تقرير العملاء</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block mb-2">الفترة</label>
                        <select id="period" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
                            <option value="all">جميع الفترات</option>
                            <option value="today">اليوم</option>
                            <option value="week">هذا الأسبوع</option>
                            <option value="month">هذا الشهر</option>
                            <option value="year">هذه السنة</option>
                        </select>
                    </div>

                    <button onclick="generateReport()" class="w-full bg-green-500 hover:bg-green-600 py-3 rounded-lg font-semibold transition-all">
                        <i class="fa-solid fa-chart-line ml-2"></i> إنشاء التقرير
                    </button>

                    <button onclick="exportToExcel()" class="w-full bg-blue-500 hover:bg-blue-600 py-3 rounded-lg font-semibold transition-all">
                        <i class="fa-solid fa-file-excel ml-2"></i> تصدير Excel
                    </button>
                </div>
            </div>

            <!-- نتائج التقرير -->
            <div class="card rounded-xl p-6 lg:col-span-2">
                <h3 class="text-xl font-bold mb-4" id="reportTitle">تقرير المبيعات</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-center" id="reportTable">
                        <!-- سيتم ملؤها بنتائج التقرير -->
                    </table>
                </div>
            </div>
        </div>

        <!-- المخططات -->
        <div class="card rounded-xl p-6">
            <h3 class="text-xl font-bold mb-4">مخطط المبيعات</h3>
            <div class="bg-white/10 rounded-lg p-6">
                <div id="salesChart" class="text-center text-white/50">
                    <i class="fa-solid fa-chart-bar text-4xl mb-2 block"></i>
                    <p>سيظهر مخطط المبيعات هنا بعد إنشاء التقرير</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let invoices = [];
        let products = [];
        let customers = [];

        // تحميل البيانات
        function loadData() {
            const data = localStorage.getItem('sawaPOSData');
            if (data) {
                const parsed = JSON.parse(data);
                invoices = parsed.invoices || [];
                products = parsed.products || [];
                customers = parsed.customers || [];
            }
            return parsed;
        }

        // تنسيق العملة
        function formatCurrency(amount) {
            const data = loadData();
            const currency = data?.settings?.currency || 'د.ع';
            return new Intl.NumberFormat('ar-IQ').format(amount) + ' ' + currency;
        }

        // تحديث الإحصائيات السريعة
        function updateQuickStats() {
            const totalSales = invoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalInvoices = invoices.length;
            const avgInvoice = totalInvoices > 0 ? totalSales / totalInvoices : 0;

            // إيجاد أفضل عميل
            const customerSales = {};
            invoices.forEach(inv => {
                if (inv.customer !== 'عميل نقدي') {
                    customerSales[inv.customer] = (customerSales[inv.customer] || 0) + inv.total;
                }
            });

            let topCustomer = '-';
            let maxSales = 0;
            Object.keys(customerSales).forEach(customer => {
                if (customerSales[customer] > maxSales) {
                    maxSales = customerSales[customer];
                    topCustomer = customer;
                }
            });

            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalInvoices').textContent = totalInvoices;
            document.getElementById('avgInvoice').textContent = formatCurrency(avgInvoice);
            document.getElementById('topCustomer').textContent = topCustomer;
        }

        // إنشاء التقرير
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const period = document.getElementById('period').value;
            
            let filteredInvoices = filterInvoicesByPeriod(period);
            
            switch(reportType) {
                case 'sales':
                    generateSalesReport(filteredInvoices);
                    break;
                case 'products':
                    generateProductsReport(filteredInvoices);
                    break;
                case 'customers':
                    generateCustomersReport(filteredInvoices);
                    break;
            }
            
            updateSalesChart(filteredInvoices);
        }

        // تصفية الفواتير حسب الفترة
        function filterInvoicesByPeriod(period) {
            if (period === 'all') return invoices;
            
            const today = new Date();
            let startDate;
            
            switch(period) {
                case 'today':
                    startDate = new Date(today);
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    startDate = new Date(today);
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case 'year':
                    startDate = new Date(today);
                    startDate.setFullYear(today.getFullYear() - 1);
                    break;
                default:
                    return invoices;
            }
            
            return invoices.filter(inv => new Date(inv.date) >= startDate);
        }

        // تقرير المبيعات
        function generateSalesReport(invoices) {
            document.getElementById('reportTitle').textContent = 'تقرير المبيعات';
            
            const salesByDate = {};
            invoices.forEach(inv => {
                salesByDate[inv.date] = (salesByDate[inv.date] || 0) + inv.total;
            });
            
            const tableHtml = `
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="pb-3">التاريخ</th>
                        <th class="pb-3">عدد الفواتير</th>
                        <th class="pb-3">إجمالي المبيعات</th>
                        <th class="pb-3">متوسط الفاتورة</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(salesByDate).map(date => {
                        const dateInvoices = invoices.filter(inv => inv.date === date);
                        const totalSales = salesByDate[date];
                        const average = totalSales / dateInvoices.length;
                        
                        return `
                            <tr class="border-b border-white/10">
                                <td class="py-3">${date}</td>
                                <td class="py-3">${dateInvoices.length}</td>
                                <td class="py-3">${formatCurrency(totalSales)}</td>
                                <td class="py-3">${formatCurrency(average)}</td>
                            </tr>
                        `;
                    }).join('')}
                    <tr class="border-t border-white/20 font-bold">
                        <td class="py-3">المجموع</td>
                        <td class="py-3">${invoices.length}</td>
                        <td class="py-3">${formatCurrency(invoices.reduce((sum, inv) => sum + inv.total, 0))}</td>
                        <td class="py-3">${formatCurrency(invoices.length > 0 ? invoices.reduce((sum, inv) => sum + inv.total, 0) / invoices.length : 0)}</td>
                    </tr>
                </tbody>
            `;
            
            document.getElementById('reportTable').innerHTML = tableHtml;
        }

        // تقرير المنتجات
        function generateProductsReport(invoices) {
            document.getElementById('reportTitle').textContent = 'تقرير المنتجات الأكثر مبيعاً';
            
            const productSales = {};
            invoices.forEach(inv => {
                inv.items.forEach(item => {
                    productSales[item.name] = productSales[item.name] || { quantity: 0, revenue: 0 };
                    productSales[item.name].quantity += item.quantity;
                    productSales[item.name].revenue += item.price * item.quantity;
                });
            });
            
            const sortedProducts = Object.keys(productSales).sort((a, b) => productSales[b].revenue - productSales[a].revenue);
            
            const tableHtml = `
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="pb-3">المنتج</th>
                        <th class="pb-3">الكمية المباعة</th>
                        <th class="pb-3">إجمالي الإيرادات</th>
                        <th class="pb-3">متوسط سعر البيع</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedProducts.map(product => {
                        const sales = productSales[product];
                        const avgPrice = sales.revenue / sales.quantity;
                        
                        return `
                            <tr class="border-b border-white/10">
                                <td class="py-3">${product}</td>
                                <td class="py-3">${sales.quantity}</td>
                                <td class="py-3">${formatCurrency(sales.revenue)}</td>
                                <td class="py-3">${formatCurrency(avgPrice)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            document.getElementById('reportTable').innerHTML = tableHtml;
        }

        // تقرير العملاء
        function generateCustomersReport(invoices) {
            document.getElementById('reportTitle').textContent = 'تقرير العملاء';
            
            const customerStats = {};
            invoices.forEach(inv => {
                if (inv.customer !== 'عميل نقدي') {
                    customerStats[inv.customer] = customerStats[inv.customer] || { invoices: 0, total: 0 };
                    customerStats[inv.customer].invoices += 1;
                    customerStats[inv.customer].total += inv.total;
                }
            });
            
            const sortedCustomers = Object.keys(customerStats).sort((a, b) => customerStats[b].total - customerStats[a].total);
            
            const tableHtml = `
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="pb-3">العميل</th>
                        <th class="pb-3">عدد الفواتير</th>
                        <th class="pb-3">إجمالي المشتريات</th>
                        <th class="pb-3">متوسط قيمة الفاتورة</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedCustomers.map(customer => {
                        const stats = customerStats[customer];
                        const avgInvoice = stats.total / stats.invoices;
                        
                        return `
                            <tr class="border-b border-white/10">
                                <td class="py-3">${customer}</td>
                                <td class="py-3">${stats.invoices}</td>
                                <td class="py-3">${formatCurrency(stats.total)}</td>
                                <td class="py-3">${formatCurrency(avgInvoice)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            document.getElementById('reportTable').innerHTML = tableHtml;
        }

        // تحديث مخطط المبيعات
        function updateSalesChart(invoices) {
            const salesByDate = {};
            invoices.forEach(inv => {
                salesByDate[inv.date] = (salesByDate[inv.date] || 0) + inv.total;
            });
            
            const dates = Object.keys(salesByDate).sort();
            const sales = dates.map(date => salesByDate[date]);
            
            // مخطط نصي بسيط
            const maxSales = Math.max(...sales);
            const chartHtml = dates.map((date, index) => {
                const percentage = (sales[index] / maxSales) * 100;
                return `
                    <div class="mb-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm">${date}</span>
                            <span class="text-sm font-semibold">${formatCurrency(sales[index])}</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-3">
                            <div class="bg-green-500 h-3 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('salesChart').innerHTML = chartHtml || `
                <div class="text-center text-white/50 py-8">
                    <i class="fa-solid fa-chart-line text-4xl mb-2"></i>
                    <p>لا توجد بيانات لعرض المخطط</p>
                </div>
            `;
        }

        // تصدير إلى Excel
        function exportToExcel() {
            const table = document.getElementById('reportTable');
            let csv = [];
            
            // العنوان
            csv.push(document.getElementById('reportTitle').textContent);
            csv.push('');
            
            // الرؤوس
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                headers.push(th.textContent);
            });
            csv.push(headers.join(','));
            
            // البيانات
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    row.push(td.textContent.replace(' د.ع', '').replace(/,/g, ''));
                });
                csv.push(row.join(','));
            });
            
            // إنشاء ملف وتنزيله
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `تقرير_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('تم تصدير التقرير بنجاح!');
        }

        // إشعارات
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // تهيئة الصفحة
        function initReports() {
            loadData();
            updateQuickStats();
            generateReport(); // إنشاء تقرير افتراضي
        }

        // تشغيل عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initReports);
    </script>
</body>
</html>